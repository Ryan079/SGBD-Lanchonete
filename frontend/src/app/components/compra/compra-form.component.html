<div class="modal-overlay" (click)="fechar.emit()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <h3>Nova Compra</h3>
    <form [formGroup]="form" (ngSubmit)="salvar()">
      <div class="form-grid">
        <div class="form-group form-group--full">
          <label>Fornecedor *</label>
          <select formControlName="cnpjFornecedor" [class.invalid]="err('cnpjFornecedor')">
            <option value="">Selecione o fornecedor...</option>
            @for (f of fornecedores; track f.cnpj) {
              <option [value]="f.cnpj">{{ f.nomeEmpresa }} ‚Äî {{ f.cnpj }}</option>
            }
          </select>
          @if (err('cnpjFornecedor')) { <span class="field-error">Fornecedor √© obrigat√≥rio</span> }
        </div>
      </div>

      <div style="margin-top:1.25rem">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem">
          <strong>Itens da Compra</strong>
          <button type="button" class="btn btn--secondary btn--sm" (click)="adicionarItem()">+ Item</button>
        </div>
        <div class="item-list" formArrayName="itens">
          @for (item of itens.controls; track $index) {
            <div [formGroupName]="$index" style="display:grid;grid-template-columns:1fr 80px 120px 120px auto;gap:.75rem;align-items:end;padding:.75rem;background:#f9fafb;border-radius:8px;border:1px solid #e5e7eb">
              <div class="form-group">
                <label>Produto *</label>
                <select formControlName="idProduto" [class.invalid]="errItem($index,'idProduto')">
                  <option [value]="null">Selecione...</option>
                  @for (p of produtos; track p.idProduto) {
                    <option [value]="p.idProduto">{{ p.nome }} ({{ p.unidadeMedida }})</option>
                  }
                </select>
                @if (errItem($index,'idProduto')) { <span class="field-error">Obrigat√≥rio</span> }
              </div>
              <div class="form-group">
                <label>Qtd *</label>
                <input type="number" formControlName="quantidade" min="1" [class.invalid]="errItem($index,'quantidade')" />
              </div>
              <div class="form-group">
                <label>Vlr Unit. (R$) *</label>
                <input type="number" formControlName="valorUnitario" min="0.01" step="0.01" [class.invalid]="errItem($index,'valorUnitario')" />
              </div>
              <div class="form-group">
                <label>Lote *</label>
                <input type="text" formControlName="lote" placeholder="Ex: L001" [class.invalid]="errItem($index,'lote')" />
              </div>
              <button type="button" class="btn--icon" (click)="removerItem($index)">üóëÔ∏è</button>
            </div>
          }
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn--secondary" (click)="fechar.emit()">Cancelar</button>
        <button type="submit" class="btn btn--primary" [disabled]="salvando">{{ salvando ? 'Salvando...' : 'Registrar Compra' }}</button>
      </div>
    </form>
  </div>
</div>
