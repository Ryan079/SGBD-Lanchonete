<div class="modal-overlay" (click)="$event.target === $event.currentTarget && fechar.emit()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <h3>Novo Pedido</h3>
    <form [formGroup]="form" (ngSubmit)="salvar()">
      <div class="form-grid">
        <div class="form-group">
          <label>CPF do Cliente *</label>
          <input type="text" formControlName="cpfCliente" placeholder="000.000.000-00"
                 [class.invalid]="err('cpfCliente')" maxlength="14" (input)="mascaraCpf($event)" />
          @if (err('cpfCliente')) { <span class="field-error">CPF √© obrigat√≥rio</span> }
        </div>
        <div class="form-group">
          <label>Taxa de Entrega (R$)</label>
          <input type="number" formControlName="taxaEntrega" min="0" step="0.01" />
        </div>
        <div class="form-group">
          <label>Troco Para (R$)</label>
          <input type="number" formControlName="trocoPara" min="0" step="0.01" />
        </div>
        <div class="form-group form-group--full">
          <label>Endere√ßo de Entrega</label>
          <input type="text" formControlName="enderecoEntrega" placeholder="Rua, n√∫mero..." />
        </div>
        <div class="form-group form-group--full">
          <label>Ponto de Refer√™ncia</label>
          <input type="text" formControlName="pontoReferencia" placeholder="Pr√≥ximo a..." />
        </div>
      </div>

      <div style="margin-top:1.25rem">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem">
          <strong>Itens do Pedido</strong>
          <button type="button" class="btn btn--secondary btn--sm" (click)="adicionarItem()">+ Item</button>
        </div>
        <div class="item-list" formArrayName="itens">
          @for (item of itens.controls; track $index) {
            <div class="item-row" [formGroupName]="$index">
              <div class="form-group">
                <label>Produto *</label>
                <select formControlName="idCardapio" [class.invalid]="errItem($index,'idCardapio')">
                  <option [value]="null">Selecione...</option>
                  @for (op of cardapioOpcoes; track op.idCardapio) {
                    <option [value]="op.idCardapio">{{ op.nome }} ‚Äî R$ {{ op.preco }}</option>
                  }
                </select>
                @if (errItem($index,'idCardapio')) { <span class="field-error">Selecione um produto</span> }
              </div>
              <div class="form-group">
                <label>Qtd *</label>
                <input type="number" formControlName="quantidade" min="1" [class.invalid]="errItem($index,'quantidade')" />
                @if (errItem($index,'quantidade')) { <span class="field-error">M√≠n. 1</span> }
              </div>
              <button type="button" class="btn--icon" (click)="removerItem($index)" title="Remover">üóëÔ∏è</button>
            </div>
          }
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn--secondary" (click)="fechar.emit()">Cancelar</button>
        <button type="submit" class="btn btn--primary" [disabled]="salvando">{{ salvando ? 'Salvando...' : 'Registrar Pedido' }}</button>
      </div>
    </form>
  </div>
</div>
